<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>캠픽 - 시간표</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <script>
  window.addEventListener("DOMContentLoaded", function () {
    feather.replace();
  });
</script>

  <style>
    :root {
      --main: #AFCBFF;
      --point: #FFA69E;
      --sub: #D6D6F5;
      --bg: #F8FAFC;
      --txt: #2E2E2E;
      --txt-sub: #9AA5B1;
      --border: #E2E6EE;
      --card: #ffffff;
      --text: #2E2E2E;
    }

    body {
      margin: 0;
      background: linear-gradient(120deg, #eaf3ff, #f8faff);
      font-family: 'Pretendard', sans-serif;
      color: var(--txt);
    }

    .app-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 18px;
      gap: 8px;
    }

    .app-logo img {
      width: 30px;
      height: 30px;
    }

    .main-back-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      color: #374151;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .main-back-btn:hover {
      background: #e5e7eb;
      color: #111827;
    }

    .main {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 20px 100px;
    }

    h1 {
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .box {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
      margin-bottom: 24px;
    }

    select,
    input {
      font-size: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-family: inherit;
    }

    .flex {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    /* 시간표 래퍼 */
    .timetable-wrapper {
      position: relative;
    }

    /* 그리드 */
    .timetable-grid {
      display: grid;
      grid-template-columns: 60px repeat(5, 1fr);
      grid-auto-rows: 60px;
      font-size: 14px;
      text-align: center;
    }

    .timetable-grid .cell {
      border: 1px solid var(--border);
      box-sizing: border-box;
      padding: 6px;
    }

    .day-header {
      font-weight: bold;
      background: var(--bg);
    }

    .time-cell {
      background: #f1f5f9;
      font-size: 12px;
      color: var(--txt-sub);
    }

    /* 블록 */
    .block {
      position: absolute;
      color: #2E2E2E;
      font-size: 13px;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      cursor: pointer;
    }

    .calendar-link {
      text-align: right;
      margin-top: 30px;
    }

    .calendar-link a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #ffffff;
      border: 1.5px solid #AFCBFF;
      border-radius: 30px;
      font-weight: 500;
      font-size: 14px;
      text-decoration: none;
      color: #2E2E2E;
    }

    .calendar-link a:hover {
      background: #F0F7FF;
    }

    .d-day {
      font-size: 12px;
      color: var(--point);
      margin-top: 4px;
    }

    .toggle-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #fff;
      border: 1.5px solid var(--main);
      border-radius: 10px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-btn:hover {
      background: #f0f7ff;
    }

    .add-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--main);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-btn:hover {
      background: #94bfff;
    }

    .gpt-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--sub);
      color: var(--text);
      border: none;
      border-radius: 10px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .gpt-btn:hover {
      background: #c5c5f0;
    }

  </style>
</head>

<body>
  <div class="app-bar">
    <div class="app-logo">
      <img src="{{ url_for('static', filename='img/campick-logo.png') }}" alt="캠픽 로고" />
      시간표
    </div>
    <a href="{{ url_for('main.index') }}" class="main-back-btn">
      <i data-feather="arrow-left-circle"></i> 메인으로
    </a>
  </div>

  <div class="container">
    <h1><i data-feather="calendar"></i> 나의 시간표</h1>

    <!-- 학기/수업 추가 박스 -->
    <div class="box">
      <div class="flex">
        <form method="get" action="{{ url_for('timetable.index') }}">
          <select name="semester" onchange="this.form.submit()">
            {% for s in semesters %}
            <option value="{{ s }}" {% if s==current_semester %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </form>
        <a href="javascript:void(0)" class="toggle-btn" onclick="toggleSemesterTools()">
          <i data-feather="settings"></i> 학기 관리
        </a>
        <a href="javascript:void(0)" class="toggle-btn" onclick="toggleCourseForm()">
          <i data-feather="plus-circle"></i> 수업 추가
        </a>
      </div>

      <div id="semester-tools" style="display:none;" class="flex">
        <form method="post" action="{{ url_for('timetable.add_semester') }}">
          <input type="text" name="new_semester" placeholder="예: 2026-1" required>
          <button class="add-btn" type="submit"><i data-feather="plus-circle"></i> 추가</button>
        </form>
        <form method="post" action="{{ url_for('timetable.delete_semester') }}">
          <select name="del_semester">
            {% for s in semesters if s != current_semester %}
            <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
          <button class="gpt-btn" type="submit"><i data-feather="trash-2"></i> 삭제</button>
        </form>
      </div>

      <div id="course-form-box" style="display:none;" class="flex">
        <form class="flex" action="{{ url_for('timetable.add_course') }}" method="post">
          <input name="subject" placeholder="과목명" required>
          <input name="prof" placeholder="교수명">
          <input name="room" placeholder="강의실">
          <select name="day">
            {% for d in days %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
          </select>
          <input name="start" placeholder="09:00" required>
          <input name="end" placeholder="10:30" required>
          <button class="add-btn" type="submit"><i data-feather="plus-circle"></i> 추가</button>
        </form>
      </div>
    </div>

    <!-- 시간표 그리드 + 블록 -->
    <div class="box">
      <div class="timetable-wrapper">
        <div class="timetable-grid">
          <div class="cell day-header">시간</div>
          {% for d in days %}<div class="cell day-header">{{ d }}</div>{% endfor %}
          {% for h in hours %}
          <div class="cell time-cell">{{ '%02d:00'|format(h) }}</div>
          {% for d in days %}<div class="cell"></div>{% endfor %}
          {% endfor %}
        </div>

        {% for b in blocks %}
        <div class="block" style="
             left: calc(60px + (100% - 60px)/5 * {{ b.col_idx }} + 2px);
             top: calc({{ b.top_px }}px + 2px);
             width: calc((100% - 60px)/5 - 4px);
             height: calc({{ b.height_px }}px - 4px);
             background: {{ b.color }};
           " onclick="openEdit(this)" data-id="{{ b.id }}" data-day="{{ b.day }}" data-subject="{{ b.subject }}"
          data-prof="{{ b.prof }}" data-room="{{ b.room }}" data-start="{{ b.start }}" data-end="{{ b.end }}"
          data-memo="{{ b.memo }}">
          <strong>{{ b.subject }}</strong><br>
          {% if b.prof %}<small>{{ b.prof }}</small>{% endif %}
          {% if b.room %}<div>({{ b.room }})</div>{% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- 주간 학습 플래너 -->
    <div class="box">
      <h2><i data-feather="edit-2"></i> 주간 학습 플래너</h2>
    
      <!-- 할 일 추가 폼 -->
      <form class="flex" action="{{ url_for('timetable.add_plan') }}" method="post">
        <input name="plan" placeholder="할 일 입력" required>
        <input type="date" name="due">
        <button class="add-btn" type="submit"><i data-feather="plus-circle"></i> 추가</button>
      </form>
    
      <!-- GPT 추천 폼 -->
      <form class="flex" action="{{ url_for('timetable.gpt') }}" method="post">
        <button class="gpt-btn">
          <i data-feather="zap"></i> GPT 추천
        </button>
      </form>
    
      <!-- 플래너 리스트 -->
      <ul style="list-style:none; padding:0; margin-top:16px;">
        {% for p in plans %}
        <li data-id="{{ p.id }}" class="{% if p.done %}task-done{% endif %}" style="background:#fff; padding:12px 16px; border-radius:12px; margin-bottom:10px;
                       display:flex; align-items:center; gap:10px; font-size:14px;
                       box-shadow:0 2px 8px rgba(0,0,0,0.04);">
          <!-- 체크박스 + 텍스트 + (마감일) -->
          <form action="{{ url_for('timetable.plan_toggle', plan_id=p.id) }}" method="post" style="margin:0; flex-grow:1;">
            <label style="display:flex; align-items:center; gap:8px; width:100%;">
              <input type="checkbox" {% if p.done %}checked{% endif %} onchange="this.form.submit()">
              <span style="{% if p.done %}text-decoration:line-through; color:var(--txt-sub);{% endif %}">
                {{ p.text }}
              </span>
              {% if p.due %}
              <div class="d-day">({{ p.due }})</div>
              {% endif %}
            </label>
          </form>

          
          <!-- 삭제 버튼 (오른쪽 끝) -->
          <form action="{{ url_for('timetable.delete_plan', plan_id=p.id) }}" method="post" style="margin:0; margin-left:auto;">
            <button class="toggle-btn" type="submit">✕</button>
          </form>

        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="calendar-link">
      <a href="{{ url_for('todolist.index') }}"><i data-feather="list"></i> To Do List 보기</a>
    </div>

    <!-- 강의 수정 모달 -->
    <div id="edit-modal" style="
         display:none; position:fixed; top:0; left:0; width:100%; height:100%;
         background:rgba(0,0,0,0.4); align-items:center; justify-content:center;
         z-index:1000;">
      <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px;">
        <button onclick="closeEdit()" style="position:absolute; top:12px; right:12px;">✕</button>
        <h3>강의 수정</h3>
        <form id="edit-course-form" method="post">
          <input type="hidden" name="id" id="edit-id">
          <label>요일<br>
            <select name="day" id="edit-day">
              {% for d in days %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
            </select>
          </label><br><br>
          <label>과목명<br><input type="text" name="subject" id="edit-subject" required></label><br><br>
          <label>교수명<br><input type="text" name="prof" id="edit-prof"></label><br><br>
          <label>강의실<br><input type="text" name="room" id="edit-room"></label><br><br>
          <label>시작<br><input type="time" name="start" id="edit-start" required></label><br><br>
          <label>종료<br><input type="time" name="end" id="edit-end" required></label><br><br>
          <label>메모<br><input type="text" name="memo" id="edit-memo"></label><br><br>
          <button type="submit" class="add-btn">저장</button>
          <button type="button" class="toggle-btn" onclick="deleteCourse()">삭제</button>
          <button type="button" class="toggle-btn" onclick="closeEdit()">취소</button>
        </form>
      </div>
    </div>

    <script>
  // Feather 아이콘 활성화
  window.addEventListener("DOMContentLoaded", function () {
    feather.replace();
  });

  // 학기 관리 박스 토글
  function toggleSemesterTools() {
    const box = document.getElementById("semester-tools");
    if (box) {
      box.style.display = box.style.display === "block" ? "none" : "block";
    }
  }

  // 수업 추가 박스 토글
  function toggleCourseForm() {
    const box = document.getElementById("course-form-box");
    if (box) {
      box.style.display = box.style.display === "block" ? "none" : "block";
    }
  }

  // 강의 수정 모달 열기
  async function openEdit(el) {
    const { id, day, subject, prof, room, start, end, memo } = el.dataset;
    document.getElementById("edit-id").value = id;
    document.getElementById("edit-day").value = day;
    document.getElementById("edit-subject").value = subject;
    document.getElementById("edit-prof").value = prof;
    document.getElementById("edit-room").value = room;
    document.getElementById("edit-start").value = start;
    document.getElementById("edit-end").value = end;
    document.getElementById("edit-memo").value = memo;
    document.getElementById("edit-course-form").action = `/timetable/edit_course/${id}`;
    document.getElementById("edit-modal").style.display = "flex";
  }

  // 강의 수정 모달 닫기
  function closeEdit() {
    document.getElementById("edit-modal").style.display = "none";
  }

  // 강의 삭제
  function deleteCourse() {
    const id = document.getElementById("edit-id").value;
    if (confirm("정말 삭제할까요?")) {
      fetch(`/timetable/delete_course/${id}`, { method: 'POST' })
        .then(() => location.reload());
    }
  }

  // ESC 키로 모달 닫기
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeEdit();
  });
</script>
</body>
</html>
