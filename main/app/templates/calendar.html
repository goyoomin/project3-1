<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>üìÖ Ìï† Ïùº Ï∫òÎ¶∞Îçî Î≥¥Í∏∞</title>

  <!-- FullCalendar CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #F8FAFC;
      color: #2E2E2E;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2E2E2E;
    }
    #calendar {
      max-width: 900px;
      margin: 40px auto;
      background-color: #FFFFFF;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .back {
      text-align: center;
      margin-top: 20px;
    }
    .back a {
      color: #FFA69E;
      text-decoration: none;
      font-weight: bold;
    }
    .fc .fc-col-header-cell {
      background-color: #D6D6F5;
      color: #2E2E2E;
      font-weight: bold;
      border: 1px solid #ccc;
    }
    .fc .fc-day-today {
      background-color: #FFA69E !important;
      color: white;
    }
    .fc-event {
      border: none;
      color: #2E2E2E;
      font-weight: 600;
      padding: 4px 6px;
      border-radius: 6px;
    }
    .fc td {
      background-color: #FFFFFF;
      border: 1px solid #E0E0E0;
    }
    .fc .fc-button {
      background-color: #D6D6F5;
      color: #2E2E2E;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      padding: 6px 12px;
      margin: 2px;
    }
    .fc .fc-button-active {
      background-color: #AFCBFF;
      color: #2E2E2E;
    }
    .fc .fc-button:hover {
      background-color: #FFA69E;
      color: white;
    }
    .fc .fc-toolbar-title {
      font-size: 22px;
      font-weight: bold;
      color: #2E2E2E;
    }
  </style>
</head>
<body>
  <h1>üìÖ Ìï† Ïùº Ï∫òÎ¶∞Îçî Î≥¥Í∏∞</h1>

  <div id="calendar"></div>

  <div class="back">
    <a href="{{ url_for('todolist.index') }}">‚Üê ToDoListÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        editable: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        buttonText: {
          today: 'Ïò§Îäò',
          month: 'ÏõîÍ∞Ñ',
          week: 'Ï£ºÍ∞Ñ'
        },
        views: {
          dayGridMonth: { buttonText: 'ÏõîÍ∞Ñ' },
          timeGridWeek: { buttonText: 'Ï£ºÍ∞Ñ' },
          timeGridDay: { buttonText: 'ÏùºÍ∞Ñ' }
        },
        dayCellContent: function(arg) {
          return arg.date.getDate();  // '1Ïùº' ‚Üí '1'
        },
        events: [
          {% for task in tasks %}
            {% if task.due %}
              {
                id: "{{ loop.index0 }}",
                title: "{{ task.title|e }}",
                start: "{{ task.due.split(' to ')[0] if 'to' in task.due else task.due }}",
                color: "{% if task.priority == 'Í∏¥Í∏â' %}#FFA69E{% elif task.priority == 'Ïó¨Ïú†' %}#D6D6F5{% else %}#AFCBFF{% endif %}",
                url: "{{ url_for('todolist.edit_task', task_id=loop.index0) }}",
                memo: "{{ task.memo|e }}"
              }{% if not loop.last %},{% endif %}
            {% endif %}
          {% endfor %}
        ],
        eventDidMount: function(info) {
          const memo = info.event.extendedProps.memo;
          if (memo) {
            const tooltip = document.createElement('div');
            tooltip.innerText = memo;
            tooltip.style.position = 'absolute';
            tooltip.style.background = '#2E2E2E';
            tooltip.style.color = 'white';
            tooltip.style.padding = '4px 8px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = 1000;
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            info.el.addEventListener('mouseenter', function (e) {
              tooltip.style.left = e.pageX + 10 + 'px';
              tooltip.style.top = e.pageY + 10 + 'px';
              tooltip.style.display = 'block';
            });
            info.el.addEventListener('mouseleave', function () {
              tooltip.style.display = 'none';
            });
          }
        },
        eventDrop: function(info) {
          const taskId = info.event.id;
          const newDate = info.event.startStr;

          fetch(`/todolist/update-date/${taskId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ new_date: newDate })
          })
          .then(response => {
            if (!response.ok) {
              alert("‚õî ÎÇ†Ïßú Î≥ÄÍ≤Ω Ïã§Ìå®!");
              info.revert();
            }
          })
          .catch(() => {
            alert("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïò§Î•ò!");
            info.revert();
          });
        }
      });

      calendar.render();
    });
  </script>
</body>
</html>
